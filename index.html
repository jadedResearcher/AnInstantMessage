<html>

<head>
  <title>An Instant Message</title>
  <link rel="stylesheet" href="index.css">
  <link rel="icon" href="alt.ico" />
  <script src="story.js"></script>
  <script>



    const pingAudio = new Audio("264828__cmdrobot__text-message-or-videogame-jump.mp3");
    let skipping = false;

    const sleep = (ms) => {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    const myLine = (line, ping) => {
      const body = document.querySelector("#chat-body");
      const ele = document.createElement("div");
      ele.className = "chat-line";
      body.append(ele);
      const fulcrum = line.indexOf(":"); //first : found is where it splits in half
      const span1 = document.createElement('span');
      span1.className = "me";
      span1.innerHTML = `${me}`;
      const span2 = document.createElement('span');
      span2.innerHTML = line.substring(fulcrum + 1).trim();
      ele.append(span1);
      ele.append(span2);
      if (ping) {
        pingAudio.play();
      }
      body.scrollTop = body.scrollHeight;
      isTypingStop();

    }


    const yourLine = (line, ping) => {
      const body = document.querySelector("#chat-body");
      const ele = document.createElement("div");
      ele.className = "chat-line";
      body.append(ele);
      const fulcrum = line.indexOf(":"); //first : found is where it splits in half
      const span1 = document.createElement('span');
      span1.className = "you";
      span1.innerHTML = `${you}`;
      const span2 = document.createElement('span');
      span2.innerHTML = line.substring(fulcrum + 1).trim();
      ele.append(span1);
      ele.append(span2);
      if (ping) {
        pingAudio.play();
      }
      body.scrollTop = body.scrollHeight;
      isTypingStop();
    }

    //low z-index, random styling but always within the chat body (its relative)
    const thoughtLine = (line) => {
      const body = document.querySelector("#chat-body");
      const ele = document.createElement("div");
      ele.className = "thought";
      ele.innerHTML = line;
      body.append(ele);
      body.scrollTop = body.scrollHeight;

    }

    const processLine = async (line, ping) => {
      if (line.trim() === "") {
        return;
      }
      if (line.includes(me)) {
        myLine(line, ping)
        !skipping && await sleep(1000);
      } else if (line.includes(you)) {
        yourLine(line, ping)
        !skipping && await sleep(1000);
      } else {
        thoughtLine(line);
      }

    }

    const setUpThePast = () => {
      const container = document.querySelector("#chat-container");
      const button = document.querySelector("#button");
      const lines = backstory.split("\n");

      for (let line of lines) {
        processLine(line);
      }
    }

    window.onmousedown = () => {
      skipping = true;
    }

    window.onmouseup = () => {
      skipping = false;
    }

    window.onload = () => {
      setUpThePast();
    }

    const isTypingStart = () => {
      console.log("JR NOTE: start")
      const body = document.querySelector("#chat-body");
      const t = document.querySelector("#typing");
      t.style.display = "block";
      body.append(t);
    }

    const isTypingStop = () => {
      console.log("JR NOTE: stop")
      const t = document.querySelector("#typing");
      t.style.display = "none";
    }

    const play = async () => {
      const lines = story.split("\n");
      const container = document.querySelector("#chat-container");
      const button = document.querySelector("#button");
      button.style.display = "none";
      container.style.display = "block";

      for (let line of lines) {
        if (line.trim() !== "") {
          isTypingStart(); //is typing is visible even if its a thought (you're waiting);
          const sleep_amount = skipping? 50: line.length * 50;
          console.log("JR NOTE: sleeping for, ", sleep_amount);
          await sleep(sleep_amount);
          await processLine(line, true);
        }
      }
    }
  </script>
</head>


<body>
  <img src="http://farragofiction.com/SBURBSim/images/Skaia_Clouds.png" id="fake-background"></div>
  <button id="button" onClick="play()">Incoming Messages...</button>

  <div id="chat-container">
    <div id="chat-header">PERSON1 -- Instant Messaging</div>
    <div id="chat-body">
      <div id="typing">Typing</div>
    </div>
  </div>

  </div>

</body>

</html>